name: jobtrail

services:
    postgres:
        image: postgres:17
        container_name: jobtrail-postgres
        environment:
            POSTGRES_DB: jobtrail
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: password
        ports:
            - "5432:5432"
        volumes:
            - jobtrail_postgres_production_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d jobtrail"]
            interval: 5s
            timeout: 5s
            retries: 10
        restart: unless-stopped

    migrations:
        build:
            context: .
            dockerfile: packages/db/Dockerfile.migrations
        container_name: jobtrail-migrations
        depends_on:
            postgres:
                condition: service_healthy
        environment:
            DATABASE_URL: postgresql://postgres:password@postgres:5432/jobtrail
        restart: on-failure

    server:
        build:
            context: .
            dockerfile: apps/server/Dockerfile
        container_name: jobtrail-server
        depends_on:
            postgres:
                condition: service_healthy
            migrations:
                condition: service_completed_successfully
        environment:
            DATABASE_URL: postgresql://postgres:password@postgres:5432/jobtrail
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-BSSfwJMM92PbbvJ4oOfunZY4K0QvCrkxRpkT0BIj6LM=}
            BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3000}
            POLAR_ACCESS_TOKEN: ${POLAR_ACCESS_TOKEN:-}
            POLAR_SUCCESS_URL: ${POLAR_SUCCESS_URL:-}
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3001}
            PORT: 3000
        ports:
            - "3000:3000"
        restart: unless-stopped
        healthcheck:
            test: curl --fail -s http://localhost:3000 || exit 1
            interval: 10s
            retries: 10
            timeout: 10s

volumes:
    jobtrail_postgres_production_data:
